{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 72, "column": 0}, "map": {"version":3,"sources":["file:///Users/santisanchez/Documents/GitHub/proyecto-gestor-uw/lib/firebase/admin.ts"],"sourcesContent":["import \"server-only\"\n\nimport { initializeApp, cert, getApps, getApp } from \"firebase-admin/app\"\nimport { getAuth } from \"firebase-admin/auth\"\nimport { getFirestore } from \"firebase-admin/firestore\"\n\nlet cachedApp: ReturnType<typeof getApp> | null = null\n\nfunction normalizePrivateKey(raw: string) {\n  const normalized = raw.trim()\n  const unquoted = normalized.replace(/^\"(.*)\"$/s, \"$1\").replace(/^'(.*)'$/s, \"$1\")\n  const withEscaped = unquoted\n    .replace(/\\\\\\\\n/g, \"\\n\")\n    .replace(/\\\\\\\\r/g, \"\\r\")\n    .replace(/\\\\n/g, \"\\n\")\n    .replace(/\\\\r/g, \"\\r\")\n  return withEscaped.replace(/\\r\\n/g, \"\\n\").replace(/\\r/g, \"\")\n}\n\nfunction getAdminApp() {\n  if (cachedApp) return cachedApp\n\n  const projectId = process.env.FIREBASE_ADMIN_PROJECT_ID\n  const clientEmail = process.env.FIREBASE_ADMIN_CLIENT_EMAIL\n  const privateKeyRaw = process.env.FIREBASE_ADMIN_PRIVATE_KEY\n\n  if (!projectId || !clientEmail || !privateKeyRaw) {\n    throw new Error(\n      \"Firebase Admin is not configured. Set FIREBASE_ADMIN_PROJECT_ID, FIREBASE_ADMIN_CLIENT_EMAIL, and FIREBASE_ADMIN_PRIVATE_KEY.\"\n    )\n  }\n\n  const privateKey = normalizePrivateKey(privateKeyRaw)\n  \n  console.log(\"[Firebase/admin] privateKeyRaw length:\", privateKeyRaw.length)\n  console.log(\"[Firebase/admin] privateKey length:\", privateKey.length)\n  console.log(\"[Firebase/admin] privateKey first 50:\", privateKey.slice(0, 50))\n  console.log(\"[Firebase/admin] privateKey last 50:\", privateKey.slice(-50))\n\n  if (!privateKey.includes(\"BEGIN PRIVATE KEY\") || !privateKey.includes(\"END PRIVATE KEY\")) {\n    throw new Error(\n      \"Firebase Admin private key is invalid. Ensure FIREBASE_ADMIN_PRIVATE_KEY is a single line with \\\\n escapes.\"\n    )\n  }\n\n  const hasDefaultApp = getApps().some((existing) => existing.name === \"[DEFAULT]\")\n\n  cachedApp = hasDefaultApp\n    ? getApp()\n    : initializeApp({\n        credential: cert({\n          projectId,\n          clientEmail,\n          privateKey,\n        }),\n        projectId,\n      })\n\n  return cachedApp\n}\n\nexport const adminAuth = new Proxy({} as ReturnType<typeof getAuth>, {\n  get(_target, prop) {\n    const auth = getAuth(getAdminApp()) as any\n    const value = auth[prop]\n    return typeof value === \"function\" ? value.bind(auth) : value\n  },\n})\n\nexport const adminDb = new Proxy({} as ReturnType<typeof getFirestore>, {\n  get(_target, prop) {\n    const db = getFirestore(getAdminApp()) as any\n    const value = db[prop]\n    return typeof value === \"function\" ? value.bind(db) : value\n  },\n})\n"],"names":[],"mappings":";;;;;;AAAA;AAEA;AACA;AACA;;;;;;;;;;;AAEA,IAAI,YAA8C;AAElD,SAAS,oBAAoB,GAAW;IACtC,MAAM,aAAa,IAAI,IAAI;IAC3B,MAAM,WAAW,WAAW,OAAO,CAAC,aAAa,MAAM,OAAO,CAAC,aAAa;IAC5E,MAAM,cAAc,SACjB,OAAO,CAAC,UAAU,MAClB,OAAO,CAAC,UAAU,MAClB,OAAO,CAAC,QAAQ,MAChB,OAAO,CAAC,QAAQ;IACnB,OAAO,YAAY,OAAO,CAAC,SAAS,MAAM,OAAO,CAAC,OAAO;AAC3D;AAEA,SAAS;IACP,IAAI,WAAW,OAAO;IAEtB,MAAM,YAAY,QAAQ,GAAG,CAAC,yBAAyB;IACvD,MAAM,cAAc,QAAQ,GAAG,CAAC,2BAA2B;IAC3D,MAAM,gBAAgB,QAAQ,GAAG,CAAC,0BAA0B;IAE5D,IAAI,CAAC,aAAa,CAAC,eAAe,CAAC,eAAe;QAChD,MAAM,IAAI,MACR;IAEJ;IAEA,MAAM,aAAa,oBAAoB;IAEvC,QAAQ,GAAG,CAAC,0CAA0C,cAAc,MAAM;IAC1E,QAAQ,GAAG,CAAC,uCAAuC,WAAW,MAAM;IACpE,QAAQ,GAAG,CAAC,yCAAyC,WAAW,KAAK,CAAC,GAAG;IACzE,QAAQ,GAAG,CAAC,wCAAwC,WAAW,KAAK,CAAC,CAAC;IAEtE,IAAI,CAAC,WAAW,QAAQ,CAAC,wBAAwB,CAAC,WAAW,QAAQ,CAAC,oBAAoB;QACxF,MAAM,IAAI,MACR;IAEJ;IAEA,MAAM,gBAAgB,IAAA,2JAAO,IAAG,IAAI,CAAC,CAAC,WAAa,SAAS,IAAI,KAAK;IAErE,YAAY,gBACR,IAAA,0JAAM,MACN,IAAA,iKAAa,EAAC;QACZ,YAAY,IAAA,wJAAI,EAAC;YACf;YACA;YACA;QACF;QACA;IACF;IAEJ,OAAO;AACT;AAEO,MAAM,YAAY,IAAI,MAAM,CAAC,GAAiC;IACnE,KAAI,OAAO,EAAE,IAAI;QACf,MAAM,OAAO,IAAA,6JAAO,EAAC;QACrB,MAAM,QAAQ,IAAI,CAAC,KAAK;QACxB,OAAO,OAAO,UAAU,aAAa,MAAM,IAAI,CAAC,QAAQ;IAC1D;AACF;AAEO,MAAM,UAAU,IAAI,MAAM,CAAC,GAAsC;IACtE,KAAI,OAAO,EAAE,IAAI;QACf,MAAM,KAAK,IAAA,4KAAY,EAAC;QACxB,MAAM,QAAQ,EAAE,CAAC,KAAK;QACtB,OAAO,OAAO,UAAU,aAAa,MAAM,IAAI,CAAC,MAAM;IACxD;AACF"}},
    {"offset": {"line": 145, "column": 0}, "map": {"version":3,"sources":["file:///Users/santisanchez/Documents/GitHub/proyecto-gestor-uw/lib/firestorePaths.ts"],"sourcesContent":["export const FIRESTORE_COLLECTIONS = {\n  centers: \"centers\",\n  legacyCenters: \"padel_centers\",\n} as const\n\nexport const CENTER_SUBCOLLECTIONS = {\n  courts: \"courts\",\n  settings: \"settings\",\n  bookings: \"bookings\",\n  classes: \"classes\",\n  availabilityRules: \"availabilityRules\",\n  legacyAvailability: \"availability\",\n} as const\n\nexport const CENTER_SETTINGS_DOCS = {\n  booking: \"booking\",\n} as const\n\nexport const LEGACY_AVAILABILITY_DOCS = {\n  config: \"config\",\n} as const\n"],"names":[],"mappings":";;;;;;;;;;AAAO,MAAM,wBAAwB;IACnC,SAAS;IACT,eAAe;AACjB;AAEO,MAAM,wBAAwB;IACnC,QAAQ;IACR,UAAU;IACV,UAAU;IACV,SAAS;IACT,mBAAmB;IACnB,oBAAoB;AACtB;AAEO,MAAM,uBAAuB;IAClC,SAAS;AACX;AAEO,MAAM,2BAA2B;IACtC,QAAQ;AACV"}},
    {"offset": {"line": 183, "column": 0}, "map": {"version":3,"sources":["file:///Users/santisanchez/Documents/GitHub/proyecto-gestor-uw/lib/firebaseBackofficeAdmin.ts"],"sourcesContent":["import * as admin from \"firebase-admin\"\n\nconst BACKOFFICE_APP_NAME = \"backoffice-admin\"\nconst isDev = process.env.NODE_ENV === \"development\"\nconst isNextBuildPhase =\n  process.env.NEXT_PHASE === \"phase-production-build\" || process.env.NEXT_PHASE === \"phase-export\"\n\nconst useEmulators = process.env.USE_FIREBASE_EMULATOR === \"true\"\n\nlet cachedApp: admin.app.App | null = null\nlet emulatorConfigured = false\n\nfunction getProjectId() {\n  if (useEmulators) {\n    return process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID || process.env.BACKOFFICE_FIREBASE_ADMIN_PROJECT_ID\n  }\n  return process.env.BACKOFFICE_FIREBASE_ADMIN_PROJECT_ID || process.env.NEXT_PUBLIC_BACKOFFICE_FIREBASE_PROJECT_ID\n}\n\nfunction normalizePrivateKey(raw: string) {\n  const normalized = raw.trim()\n  const unquoted = normalized.replace(/^\"(.*)\"$/s, \"$1\").replace(/^'(.*)'$/s, \"$1\")\n  const withEscaped = unquoted\n    .replace(/\\\\\\\\n/g, \"\\n\")\n    .replace(/\\\\\\\\r/g, \"\\r\")\n    .replace(/\\\\n/g, \"\\n\")\n    .replace(/\\\\r/g, \"\\r\")\n  return withEscaped.replace(/\\r\\n/g, \"\\n\").replace(/\\r/g, \"\")\n}\n\nfunction getBackofficeAdminApp() {\n  if (cachedApp) return cachedApp\n\n  const existing = admin.apps.find((app) => app.name === BACKOFFICE_APP_NAME)\n  if (existing) {\n    cachedApp = existing\n    return cachedApp\n  }\n\n  if (useEmulators) {\n    if (!process.env.FIREBASE_AUTH_EMULATOR_HOST) {\n      process.env.FIREBASE_AUTH_EMULATOR_HOST = \"127.0.0.1:9099\"\n    }\n    if (!process.env.FIRESTORE_EMULATOR_HOST) {\n      process.env.FIRESTORE_EMULATOR_HOST = \"127.0.0.1:8080\"\n    }\n\n    admin.initializeApp(\n      {\n        projectId: getProjectId(),\n      },\n      BACKOFFICE_APP_NAME\n    )\n    cachedApp = admin.app(BACKOFFICE_APP_NAME)\n    return cachedApp\n  }\n\n  const projectId = process.env.BACKOFFICE_FIREBASE_ADMIN_PROJECT_ID\n  const clientEmail = process.env.BACKOFFICE_FIREBASE_ADMIN_CLIENT_EMAIL\n  const privateKeyRaw = process.env.BACKOFFICE_FIREBASE_ADMIN_PRIVATE_KEY\n\n  if (!projectId || !clientEmail || !privateKeyRaw) {\n    if (!isNextBuildPhase) {\n      throw new Error(\n        \"Backoffice Firebase Admin is not configured. Set BACKOFFICE_FIREBASE_ADMIN_PROJECT_ID, BACKOFFICE_FIREBASE_ADMIN_CLIENT_EMAIL, and BACKOFFICE_FIREBASE_ADMIN_PRIVATE_KEY.\"\n      )\n    }\n\n    admin.initializeApp(\n      {\n        projectId: getProjectId(),\n      },\n      BACKOFFICE_APP_NAME\n    )\n    cachedApp = admin.app(BACKOFFICE_APP_NAME)\n    return cachedApp\n  }\n\n  const privateKey = normalizePrivateKey(privateKeyRaw)\n  const invalidKey = !privateKey.includes(\"BEGIN PRIVATE KEY\") || !privateKey.includes(\"END PRIVATE KEY\")\n  if (invalidKey) {\n    if (!isNextBuildPhase) {\n      throw new Error(\n        \"Backoffice Firebase Admin private key is invalid. Ensure BACKOFFICE_FIREBASE_ADMIN_PRIVATE_KEY is a single line with \\\\n escapes.\"\n      )\n    }\n\n    admin.initializeApp(\n      {\n        projectId: getProjectId(),\n      },\n      BACKOFFICE_APP_NAME\n    )\n    cachedApp = admin.app(BACKOFFICE_APP_NAME)\n    return cachedApp\n  }\n\n  try {\n    admin.initializeApp(\n      {\n        credential: admin.credential.cert({\n          projectId,\n          clientEmail,\n          privateKey,\n        }),\n        databaseURL: `https://${projectId}.firebaseio.com`,\n      },\n      BACKOFFICE_APP_NAME\n    )\n    cachedApp = admin.app(BACKOFFICE_APP_NAME)\n    return cachedApp\n  } catch (error) {\n    if (isDev) {\n      console.warn(`[Firebase][backoffice] Admin init failed: ${(error as Error)?.message || error}`)\n    }\n    if (!isNextBuildPhase) {\n      throw error\n    }\n\n    admin.initializeApp(\n      {\n        projectId: getProjectId(),\n      },\n      BACKOFFICE_APP_NAME\n    )\n    cachedApp = admin.app(BACKOFFICE_APP_NAME)\n    return cachedApp\n  }\n}\n\nexport const backofficeAdminAuth = new Proxy({} as ReturnType<admin.app.App[\"auth\"]>, {\n  get(_target, prop) {\n    const auth = getBackofficeAdminApp().auth() as any\n    const value = auth[prop]\n    return typeof value === \"function\" ? value.bind(auth) : value\n  },\n})\n\nexport const backofficeAdminDb = new Proxy({} as ReturnType<admin.app.App[\"firestore\"]>, {\n  get(_target, prop) {\n    const db = getBackofficeAdminApp().firestore() as any\n    if (useEmulators && !emulatorConfigured) {\n      try {\n        const host = process.env.FIRESTORE_EMULATOR_HOST || \"localhost:8080\"\n        db.settings({ host, ssl: false })\n      } catch {\n        // ignore if settings already applied\n      }\n      emulatorConfigured = true\n    }\n    const value = db[prop]\n    return typeof value === \"function\" ? value.bind(db) : value\n  },\n})\n\nif (isDev) {\n  const projectId = getProjectId() || \"unknown\"\n  console.log(`[Firebase][backoffice] projectId=${projectId} emulator=${useEmulators ? \"ON\" : \"OFF\"}`)\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 313, "column": 0}, "map": {"version":3,"sources":["file:///Users/santisanchez/Documents/GitHub/proyecto-gestor-uw/lib/backoffice/server-auth.ts"],"sourcesContent":["import { backofficeAdminAuth, backofficeAdminDb } from \"@/lib/firebaseBackofficeAdmin\"\n\nexport type BackofficeActor = {\n  uid: string\n  email?: string\n}\n\nconst isDev = process.env.NODE_ENV === \"development\"\n\nfunction parseBearerToken(headerValue: string | null) {\n  if (!headerValue) return null\n  const [scheme, token] = headerValue.split(\" \")\n  if (scheme?.toLowerCase() !== \"bearer\") return null\n  return token || null\n}\n\nfunction getAdminAllowlist() {\n  const raw = process.env.BACKOFFICE_PLATFORM_ADMIN_EMAILS || \"\"\n  const allowlist = new Set(\n    raw\n      .split(\",\")\n      .map((s) => s.trim().toLowerCase())\n      .filter(Boolean)\n  )\n  return { allowlist, raw }\n}\n\nexport async function requirePlatformAdmin(request: Request): Promise<BackofficeActor> {\n  const token = parseBearerToken(request.headers.get(\"authorization\"))\n  if (!token) {\n    throw new Response(JSON.stringify({ error: \"Missing Authorization header\" }), {\n      status: 401,\n      headers: { \"Content-Type\": \"application/json\" },\n    })\n  }\n\n  let decoded: { uid: string; email?: string }\n  try {\n    decoded = await backofficeAdminAuth.verifyIdToken(token)\n  } catch {\n    throw new Response(JSON.stringify({ error: \"Invalid token\" }), {\n      status: 401,\n      headers: { \"Content-Type\": \"application/json\" },\n    })\n  }\n\n  const userRef = backofficeAdminDb.collection(\"users\").doc(decoded.uid)\n  let snap: FirebaseFirestore.DocumentSnapshot | null = null\n\n  const { allowlist, raw } = getAdminAllowlist()\n  const emailLower = (decoded.email || \"\").toLowerCase()\n\n  if (isDev) {\n    const projectId = backofficeAdminAuth.app?.options?.projectId || \"unknown\"\n    console.log(\n      `[BackofficeAuth] user.email=${decoded.email || \"\"} uid=${decoded.uid} projectId=${projectId} allowlist=${raw || \"\"}`\n    )\n  }\n\n  if (!raw || allowlist.size === 0) {\n    throw new Response(\n      JSON.stringify({\n        error:\n          \"BACKOFFICE_PLATFORM_ADMIN_EMAILS is not set. Add it to .env.local (e.g. BACKOFFICE_PLATFORM_ADMIN_EMAILS=admin@example.com,other@example.com).\",\n      }),\n      {\n        status: 500,\n        headers: { \"Content-Type\": \"application/json\" },\n      }\n    )\n  }\n\n  const isAllowlisted = !!emailLower && allowlist.has(emailLower)\n\n  try {\n    snap = await userRef.get()\n  } catch (error: any) {\n    if (isDev) {\n      console.warn(`[BackofficeAuth] Failed to read user doc: ${error?.message || error}`)\n    }\n\n    if (isAllowlisted) {\n      // Allow allowlisted user even if Firestore is unavailable.\n      try {\n        await backofficeAdminAuth.setCustomUserClaims(decoded.uid, { platform_admin: true })\n      } catch (claimError: any) {\n        if (isDev) {\n          console.warn(`[BackofficeAuth] Failed to set custom claims: ${claimError?.message || claimError}`)\n        }\n      }\n      return { uid: decoded.uid, email: decoded.email }\n    }\n\n    throw new Response(\n      JSON.stringify({\n        error:\n          \"Backoffice Firestore is unavailable. Enable Firestore in the backoffice project or add the user to BACKOFFICE_PLATFORM_ADMIN_EMAILS.\",\n      }),\n      {\n        status: 500,\n        headers: { \"Content-Type\": \"application/json\" },\n      }\n    )\n  }\n\n  if (isDev && snap) {\n    console.log(\n      `[BackofficeAuth] roleDoc.exists=${snap.exists} roleDoc.data=${snap.exists ? JSON.stringify(snap.data() || {}) : \"null\"}`\n    )\n  }\n\n  if (isAllowlisted) {\n    // Allow allowlisted users even if role doc is missing or outdated.\n    try {\n      await userRef.set(\n        {\n          role: \"platform_admin\",\n          lastLoginAt: new Date(),\n        },\n        { merge: true }\n      )\n    } catch (error: any) {\n      if (isDev) {\n        console.warn(`[BackofficeAuth] Failed to upsert role doc: ${error?.message || error}`)\n      }\n    }\n\n    try {\n      await backofficeAdminAuth.setCustomUserClaims(decoded.uid, { platform_admin: true })\n    } catch (error: any) {\n      if (isDev) {\n        console.warn(`[BackofficeAuth] Failed to set custom claims: ${error?.message || error}`)\n      }\n    }\n\n    return { uid: decoded.uid, email: decoded.email }\n  }\n\n  if (!snap.exists) {\n    // Bootstrap: if the email is allowlisted, create platform_admin user doc.\n    throw new Response(JSON.stringify({ error: \"Forbidden\" }), {\n      status: 403,\n      headers: { \"Content-Type\": \"application/json\" },\n    })\n  }\n\n  const data = snap.data() as any\n  if (data?.role !== \"platform_admin\") {\n    throw new Response(JSON.stringify({ error: \"Forbidden\" }), {\n      status: 403,\n      headers: { \"Content-Type\": \"application/json\" },\n    })\n  }\n\n  await userRef.set({ lastLoginAt: new Date() }, { merge: true })\n  return { uid: decoded.uid, email: decoded.email }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 478, "column": 0}, "map": {"version":3,"sources":["file:///Users/santisanchez/Documents/GitHub/proyecto-gestor-uw/app/api/backoffice/centers/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { adminDb } from \"@/lib/firebase/admin\"\nimport { CENTER_SUBCOLLECTIONS, FIRESTORE_COLLECTIONS } from \"@/lib/firestorePaths\"\nimport { requirePlatformAdmin } from \"@/lib/backoffice/server-auth\"\n\nexport async function GET(request: Request) {\n  try {\n    await requirePlatformAdmin(request)\n\n    const url = new URL(request.url)\n    const q = (url.searchParams.get(\"q\") || \"\").trim().toLowerCase()\n\n    const [centersSnap, legacySnap, courtsSnap] = await Promise.all([\n      adminDb.collection(FIRESTORE_COLLECTIONS.centers).limit(200).get(),\n      adminDb.collection(FIRESTORE_COLLECTIONS.legacyCenters).limit(200).get(),\n      adminDb.collectionGroup(CENTER_SUBCOLLECTIONS.courts).get(),\n    ])\n\n    const fromCenters = centersSnap.docs.map((d) => ({\n      centerId: d.id,\n      source: FIRESTORE_COLLECTIONS.centers,\n      ...(d.data() as any),\n    }))\n    const fromLegacy = legacySnap.docs.map((d) => ({\n      centerId: d.id,\n      source: FIRESTORE_COLLECTIONS.legacyCenters,\n      ...(d.data() as any),\n      // Normalize legacy shape\n      slug: (d.data() as any)?.slug ?? null,\n      published: (d.data() as any)?.published ?? false,\n    }))\n\n    // Prefer new model if both exist\n    const map = new Map<string, any>()\n    for (const item of fromLegacy) map.set(String(item.centerId), item)\n    for (const item of fromCenters) map.set(String(item.centerId), item)\n\n    const courtsByCenter = new Map<string, { count: number; sports: Set<string> }>()\n    for (const doc of courtsSnap.docs) {\n      const parent = doc.ref.parent.parent\n      const centerId = parent?.id\n      if (!centerId) continue\n      const data = doc.data() as any\n      const sport = String(data?.sport || \"\").toLowerCase()\n      const entry = courtsByCenter.get(centerId) || { count: 0, sports: new Set<string>() }\n      entry.count += 1\n      if (sport) entry.sports.add(sport)\n      courtsByCenter.set(centerId, entry)\n    }\n\n    const centerIds = Array.from(map.keys())\n    const adminRefs = centerIds.map((id) => adminDb.collection(\"center_admins\").doc(id))\n    const adminSnaps = adminRefs.length ? await adminDb.getAll(...adminRefs) : []\n    const adminMap = new Map<string, any>()\n    for (const snap of adminSnaps) {\n      if (snap.exists) adminMap.set(snap.id, snap.data())\n    }\n\n    const items = Array.from(map.values()).map((item) => {\n      const stats = courtsByCenter.get(String(item.centerId))\n      const owner = adminMap.get(String(item.centerId))\n      return {\n        ...item,\n        ownerEmail: owner?.email || null,\n        courtsCount: stats?.count ?? 0,\n        sports: stats ? Array.from(stats.sports.values()) : [],\n      }\n    })\n\n    const filtered = q\n      ? items.filter((c) => {\n          const name = String(c.name || \"\").toLowerCase()\n          const email = String(c.email || \"\").toLowerCase()\n          const ownerEmail = String(c.ownerEmail || \"\").toLowerCase()\n          const slug = String(c.slug || \"\").toLowerCase()\n          return (\n            name.includes(q) ||\n            email.includes(q) ||\n            ownerEmail.includes(q) ||\n            slug.includes(q) ||\n            String(c.centerId).includes(q)\n          )\n        })\n      : items\n\n    return NextResponse.json({ items: filtered })\n  } catch (e: any) {\n    if (e instanceof Response) return e\n    console.error(\"[BackofficeCenters] Error:\", e?.message || e, e?.stack)\n    return NextResponse.json({ error: e?.message || \"Failed\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}