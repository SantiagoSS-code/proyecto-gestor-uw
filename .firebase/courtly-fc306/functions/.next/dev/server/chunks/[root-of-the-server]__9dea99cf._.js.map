{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 72, "column": 0}, "map": {"version":3,"sources":["file:///Users/santisanchez/Documents/GitHub/proyecto-gestor-uw/lib/firebase/admin.ts"],"sourcesContent":["import \"server-only\"\n\nimport { initializeApp, cert, getApps, getApp } from \"firebase-admin/app\"\nimport { getAuth } from \"firebase-admin/auth\"\nimport { getFirestore } from \"firebase-admin/firestore\"\n\nlet cachedApp: ReturnType<typeof getApp> | null = null\n\nfunction normalizePrivateKey(raw: string) {\n  const normalized = raw.trim()\n  const unquoted = normalized.replace(/^\"(.*)\"$/s, \"$1\").replace(/^'(.*)'$/s, \"$1\")\n  const withEscaped = unquoted\n    .replace(/\\\\\\\\n/g, \"\\n\")\n    .replace(/\\\\\\\\r/g, \"\\r\")\n    .replace(/\\\\n/g, \"\\n\")\n    .replace(/\\\\r/g, \"\\r\")\n  return withEscaped.replace(/\\r\\n/g, \"\\n\").replace(/\\r/g, \"\")\n}\n\nfunction getAdminApp() {\n  if (cachedApp) return cachedApp\n\n  const projectId = process.env.FIREBASE_ADMIN_PROJECT_ID\n  const clientEmail = process.env.FIREBASE_ADMIN_CLIENT_EMAIL\n  const privateKeyRaw = process.env.FIREBASE_ADMIN_PRIVATE_KEY\n\n  if (!projectId || !clientEmail || !privateKeyRaw) {\n    throw new Error(\n      \"Firebase Admin is not configured. Set FIREBASE_ADMIN_PROJECT_ID, FIREBASE_ADMIN_CLIENT_EMAIL, and FIREBASE_ADMIN_PRIVATE_KEY.\"\n    )\n  }\n\n  const privateKey = normalizePrivateKey(privateKeyRaw)\n  \n  console.log(\"[Firebase/admin] privateKeyRaw length:\", privateKeyRaw.length)\n  console.log(\"[Firebase/admin] privateKey length:\", privateKey.length)\n  console.log(\"[Firebase/admin] privateKey first 50:\", privateKey.slice(0, 50))\n  console.log(\"[Firebase/admin] privateKey last 50:\", privateKey.slice(-50))\n\n  if (!privateKey.includes(\"BEGIN PRIVATE KEY\") || !privateKey.includes(\"END PRIVATE KEY\")) {\n    throw new Error(\n      \"Firebase Admin private key is invalid. Ensure FIREBASE_ADMIN_PRIVATE_KEY is a single line with \\\\n escapes.\"\n    )\n  }\n\n  const hasDefaultApp = getApps().some((existing) => existing.name === \"[DEFAULT]\")\n\n  cachedApp = hasDefaultApp\n    ? getApp()\n    : initializeApp({\n        credential: cert({\n          projectId,\n          clientEmail,\n          privateKey,\n        }),\n        projectId,\n      })\n\n  return cachedApp\n}\n\nexport const adminAuth = new Proxy({} as ReturnType<typeof getAuth>, {\n  get(_target, prop) {\n    const auth = getAuth(getAdminApp()) as any\n    const value = auth[prop]\n    return typeof value === \"function\" ? value.bind(auth) : value\n  },\n})\n\nexport const adminDb = new Proxy({} as ReturnType<typeof getFirestore>, {\n  get(_target, prop) {\n    const db = getFirestore(getAdminApp()) as any\n    const value = db[prop]\n    return typeof value === \"function\" ? value.bind(db) : value\n  },\n})\n"],"names":[],"mappings":";;;;;;AAAA;AAEA;AACA;AACA;;;;;;;;;;;AAEA,IAAI,YAA8C;AAElD,SAAS,oBAAoB,GAAW;IACtC,MAAM,aAAa,IAAI,IAAI;IAC3B,MAAM,WAAW,WAAW,OAAO,CAAC,aAAa,MAAM,OAAO,CAAC,aAAa;IAC5E,MAAM,cAAc,SACjB,OAAO,CAAC,UAAU,MAClB,OAAO,CAAC,UAAU,MAClB,OAAO,CAAC,QAAQ,MAChB,OAAO,CAAC,QAAQ;IACnB,OAAO,YAAY,OAAO,CAAC,SAAS,MAAM,OAAO,CAAC,OAAO;AAC3D;AAEA,SAAS;IACP,IAAI,WAAW,OAAO;IAEtB,MAAM,YAAY,QAAQ,GAAG,CAAC,yBAAyB;IACvD,MAAM,cAAc,QAAQ,GAAG,CAAC,2BAA2B;IAC3D,MAAM,gBAAgB,QAAQ,GAAG,CAAC,0BAA0B;IAE5D,IAAI,CAAC,aAAa,CAAC,eAAe,CAAC,eAAe;QAChD,MAAM,IAAI,MACR;IAEJ;IAEA,MAAM,aAAa,oBAAoB;IAEvC,QAAQ,GAAG,CAAC,0CAA0C,cAAc,MAAM;IAC1E,QAAQ,GAAG,CAAC,uCAAuC,WAAW,MAAM;IACpE,QAAQ,GAAG,CAAC,yCAAyC,WAAW,KAAK,CAAC,GAAG;IACzE,QAAQ,GAAG,CAAC,wCAAwC,WAAW,KAAK,CAAC,CAAC;IAEtE,IAAI,CAAC,WAAW,QAAQ,CAAC,wBAAwB,CAAC,WAAW,QAAQ,CAAC,oBAAoB;QACxF,MAAM,IAAI,MACR;IAEJ;IAEA,MAAM,gBAAgB,IAAA,2JAAO,IAAG,IAAI,CAAC,CAAC,WAAa,SAAS,IAAI,KAAK;IAErE,YAAY,gBACR,IAAA,0JAAM,MACN,IAAA,iKAAa,EAAC;QACZ,YAAY,IAAA,wJAAI,EAAC;YACf;YACA;YACA;QACF;QACA;IACF;IAEJ,OAAO;AACT;AAEO,MAAM,YAAY,IAAI,MAAM,CAAC,GAAiC;IACnE,KAAI,OAAO,EAAE,IAAI;QACf,MAAM,OAAO,IAAA,6JAAO,EAAC;QACrB,MAAM,QAAQ,IAAI,CAAC,KAAK;QACxB,OAAO,OAAO,UAAU,aAAa,MAAM,IAAI,CAAC,QAAQ;IAC1D;AACF;AAEO,MAAM,UAAU,IAAI,MAAM,CAAC,GAAsC;IACtE,KAAI,OAAO,EAAE,IAAI;QACf,MAAM,KAAK,IAAA,4KAAY,EAAC;QACxB,MAAM,QAAQ,EAAE,CAAC,KAAK;QACtB,OAAO,OAAO,UAAU,aAAa,MAAM,IAAI,CAAC,MAAM;IACxD;AACF"}},
    {"offset": {"line": 151, "column": 0}, "map": {"version":3,"sources":["file:///Users/santisanchez/Documents/GitHub/proyecto-gestor-uw/lib/firebaseBackofficeAdmin.ts"],"sourcesContent":["import * as admin from \"firebase-admin\"\n\nconst BACKOFFICE_APP_NAME = \"backoffice-admin\"\nconst isDev = process.env.NODE_ENV === \"development\"\nconst isNextBuildPhase =\n  process.env.NEXT_PHASE === \"phase-production-build\" || process.env.NEXT_PHASE === \"phase-export\"\n\nconst useEmulators = process.env.USE_FIREBASE_EMULATOR === \"true\"\n\nlet cachedApp: admin.app.App | null = null\nlet emulatorConfigured = false\n\nfunction getProjectId() {\n  if (useEmulators) {\n    return process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID || process.env.BACKOFFICE_FIREBASE_ADMIN_PROJECT_ID\n  }\n  return process.env.BACKOFFICE_FIREBASE_ADMIN_PROJECT_ID || process.env.NEXT_PUBLIC_BACKOFFICE_FIREBASE_PROJECT_ID\n}\n\nfunction normalizePrivateKey(raw: string) {\n  const normalized = raw.trim()\n  const unquoted = normalized.replace(/^\"(.*)\"$/s, \"$1\").replace(/^'(.*)'$/s, \"$1\")\n  const withEscaped = unquoted\n    .replace(/\\\\\\\\n/g, \"\\n\")\n    .replace(/\\\\\\\\r/g, \"\\r\")\n    .replace(/\\\\n/g, \"\\n\")\n    .replace(/\\\\r/g, \"\\r\")\n  return withEscaped.replace(/\\r\\n/g, \"\\n\").replace(/\\r/g, \"\")\n}\n\nfunction getBackofficeAdminApp() {\n  if (cachedApp) return cachedApp\n\n  const existing = admin.apps.find((app) => app.name === BACKOFFICE_APP_NAME)\n  if (existing) {\n    cachedApp = existing\n    return cachedApp\n  }\n\n  if (useEmulators) {\n    if (!process.env.FIREBASE_AUTH_EMULATOR_HOST) {\n      process.env.FIREBASE_AUTH_EMULATOR_HOST = \"127.0.0.1:9099\"\n    }\n    if (!process.env.FIRESTORE_EMULATOR_HOST) {\n      process.env.FIRESTORE_EMULATOR_HOST = \"127.0.0.1:8080\"\n    }\n\n    admin.initializeApp(\n      {\n        projectId: getProjectId(),\n      },\n      BACKOFFICE_APP_NAME\n    )\n    cachedApp = admin.app(BACKOFFICE_APP_NAME)\n    return cachedApp\n  }\n\n  const projectId = process.env.BACKOFFICE_FIREBASE_ADMIN_PROJECT_ID\n  const clientEmail = process.env.BACKOFFICE_FIREBASE_ADMIN_CLIENT_EMAIL\n  const privateKeyRaw = process.env.BACKOFFICE_FIREBASE_ADMIN_PRIVATE_KEY\n\n  if (!projectId || !clientEmail || !privateKeyRaw) {\n    if (!isNextBuildPhase) {\n      throw new Error(\n        \"Backoffice Firebase Admin is not configured. Set BACKOFFICE_FIREBASE_ADMIN_PROJECT_ID, BACKOFFICE_FIREBASE_ADMIN_CLIENT_EMAIL, and BACKOFFICE_FIREBASE_ADMIN_PRIVATE_KEY.\"\n      )\n    }\n\n    admin.initializeApp(\n      {\n        projectId: getProjectId(),\n      },\n      BACKOFFICE_APP_NAME\n    )\n    cachedApp = admin.app(BACKOFFICE_APP_NAME)\n    return cachedApp\n  }\n\n  const privateKey = normalizePrivateKey(privateKeyRaw)\n  const invalidKey = !privateKey.includes(\"BEGIN PRIVATE KEY\") || !privateKey.includes(\"END PRIVATE KEY\")\n  if (invalidKey) {\n    if (!isNextBuildPhase) {\n      throw new Error(\n        \"Backoffice Firebase Admin private key is invalid. Ensure BACKOFFICE_FIREBASE_ADMIN_PRIVATE_KEY is a single line with \\\\n escapes.\"\n      )\n    }\n\n    admin.initializeApp(\n      {\n        projectId: getProjectId(),\n      },\n      BACKOFFICE_APP_NAME\n    )\n    cachedApp = admin.app(BACKOFFICE_APP_NAME)\n    return cachedApp\n  }\n\n  try {\n    admin.initializeApp(\n      {\n        credential: admin.credential.cert({\n          projectId,\n          clientEmail,\n          privateKey,\n        }),\n        databaseURL: `https://${projectId}.firebaseio.com`,\n      },\n      BACKOFFICE_APP_NAME\n    )\n    cachedApp = admin.app(BACKOFFICE_APP_NAME)\n    return cachedApp\n  } catch (error) {\n    if (isDev) {\n      console.warn(`[Firebase][backoffice] Admin init failed: ${(error as Error)?.message || error}`)\n    }\n    if (!isNextBuildPhase) {\n      throw error\n    }\n\n    admin.initializeApp(\n      {\n        projectId: getProjectId(),\n      },\n      BACKOFFICE_APP_NAME\n    )\n    cachedApp = admin.app(BACKOFFICE_APP_NAME)\n    return cachedApp\n  }\n}\n\nexport const backofficeAdminAuth = new Proxy({} as ReturnType<admin.app.App[\"auth\"]>, {\n  get(_target, prop) {\n    const auth = getBackofficeAdminApp().auth() as any\n    const value = auth[prop]\n    return typeof value === \"function\" ? value.bind(auth) : value\n  },\n})\n\nexport const backofficeAdminDb = new Proxy({} as ReturnType<admin.app.App[\"firestore\"]>, {\n  get(_target, prop) {\n    const db = getBackofficeAdminApp().firestore() as any\n    if (useEmulators && !emulatorConfigured) {\n      try {\n        const host = process.env.FIRESTORE_EMULATOR_HOST || \"localhost:8080\"\n        db.settings({ host, ssl: false })\n      } catch {\n        // ignore if settings already applied\n      }\n      emulatorConfigured = true\n    }\n    const value = db[prop]\n    return typeof value === \"function\" ? value.bind(db) : value\n  },\n})\n\nif (isDev) {\n  const projectId = getProjectId() || \"unknown\"\n  console.log(`[Firebase][backoffice] projectId=${projectId} emulator=${useEmulators ? \"ON\" : \"OFF\"}`)\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 281, "column": 0}, "map": {"version":3,"sources":["file:///Users/santisanchez/Documents/GitHub/proyecto-gestor-uw/lib/backoffice/server-auth.ts"],"sourcesContent":["import { backofficeAdminAuth, backofficeAdminDb } from \"@/lib/firebaseBackofficeAdmin\"\n\nexport type BackofficeActor = {\n  uid: string\n  email?: string\n}\n\nconst isDev = process.env.NODE_ENV === \"development\"\n\nfunction parseBearerToken(headerValue: string | null) {\n  if (!headerValue) return null\n  const [scheme, token] = headerValue.split(\" \")\n  if (scheme?.toLowerCase() !== \"bearer\") return null\n  return token || null\n}\n\nfunction getAdminAllowlist() {\n  const raw = process.env.BACKOFFICE_PLATFORM_ADMIN_EMAILS || \"\"\n  const allowlist = new Set(\n    raw\n      .split(\",\")\n      .map((s) => s.trim().toLowerCase())\n      .filter(Boolean)\n  )\n  return { allowlist, raw }\n}\n\nexport async function requirePlatformAdmin(request: Request): Promise<BackofficeActor> {\n  const token = parseBearerToken(request.headers.get(\"authorization\"))\n  if (!token) {\n    throw new Response(JSON.stringify({ error: \"Missing Authorization header\" }), {\n      status: 401,\n      headers: { \"Content-Type\": \"application/json\" },\n    })\n  }\n\n  let decoded: { uid: string; email?: string }\n  try {\n    decoded = await backofficeAdminAuth.verifyIdToken(token)\n  } catch {\n    throw new Response(JSON.stringify({ error: \"Invalid token\" }), {\n      status: 401,\n      headers: { \"Content-Type\": \"application/json\" },\n    })\n  }\n\n  const userRef = backofficeAdminDb.collection(\"users\").doc(decoded.uid)\n  let snap: FirebaseFirestore.DocumentSnapshot | null = null\n\n  const { allowlist, raw } = getAdminAllowlist()\n  const emailLower = (decoded.email || \"\").toLowerCase()\n\n  if (isDev) {\n    const projectId = backofficeAdminAuth.app?.options?.projectId || \"unknown\"\n    console.log(\n      `[BackofficeAuth] user.email=${decoded.email || \"\"} uid=${decoded.uid} projectId=${projectId} allowlist=${raw || \"\"}`\n    )\n  }\n\n  if (!raw || allowlist.size === 0) {\n    throw new Response(\n      JSON.stringify({\n        error:\n          \"BACKOFFICE_PLATFORM_ADMIN_EMAILS is not set. Add it to .env.local (e.g. BACKOFFICE_PLATFORM_ADMIN_EMAILS=admin@example.com,other@example.com).\",\n      }),\n      {\n        status: 500,\n        headers: { \"Content-Type\": \"application/json\" },\n      }\n    )\n  }\n\n  const isAllowlisted = !!emailLower && allowlist.has(emailLower)\n\n  try {\n    snap = await userRef.get()\n  } catch (error: any) {\n    if (isDev) {\n      console.warn(`[BackofficeAuth] Failed to read user doc: ${error?.message || error}`)\n    }\n\n    if (isAllowlisted) {\n      // Allow allowlisted user even if Firestore is unavailable.\n      try {\n        await backofficeAdminAuth.setCustomUserClaims(decoded.uid, { platform_admin: true })\n      } catch (claimError: any) {\n        if (isDev) {\n          console.warn(`[BackofficeAuth] Failed to set custom claims: ${claimError?.message || claimError}`)\n        }\n      }\n      return { uid: decoded.uid, email: decoded.email }\n    }\n\n    throw new Response(\n      JSON.stringify({\n        error:\n          \"Backoffice Firestore is unavailable. Enable Firestore in the backoffice project or add the user to BACKOFFICE_PLATFORM_ADMIN_EMAILS.\",\n      }),\n      {\n        status: 500,\n        headers: { \"Content-Type\": \"application/json\" },\n      }\n    )\n  }\n\n  if (isDev && snap) {\n    console.log(\n      `[BackofficeAuth] roleDoc.exists=${snap.exists} roleDoc.data=${snap.exists ? JSON.stringify(snap.data() || {}) : \"null\"}`\n    )\n  }\n\n  if (isAllowlisted) {\n    // Allow allowlisted users even if role doc is missing or outdated.\n    try {\n      await userRef.set(\n        {\n          role: \"platform_admin\",\n          lastLoginAt: new Date(),\n        },\n        { merge: true }\n      )\n    } catch (error: any) {\n      if (isDev) {\n        console.warn(`[BackofficeAuth] Failed to upsert role doc: ${error?.message || error}`)\n      }\n    }\n\n    try {\n      await backofficeAdminAuth.setCustomUserClaims(decoded.uid, { platform_admin: true })\n    } catch (error: any) {\n      if (isDev) {\n        console.warn(`[BackofficeAuth] Failed to set custom claims: ${error?.message || error}`)\n      }\n    }\n\n    return { uid: decoded.uid, email: decoded.email }\n  }\n\n  if (!snap.exists) {\n    // Bootstrap: if the email is allowlisted, create platform_admin user doc.\n    throw new Response(JSON.stringify({ error: \"Forbidden\" }), {\n      status: 403,\n      headers: { \"Content-Type\": \"application/json\" },\n    })\n  }\n\n  const data = snap.data() as any\n  if (data?.role !== \"platform_admin\") {\n    throw new Response(JSON.stringify({ error: \"Forbidden\" }), {\n      status: 403,\n      headers: { \"Content-Type\": \"application/json\" },\n    })\n  }\n\n  await userRef.set({ lastLoginAt: new Date() }, { merge: true })\n  return { uid: decoded.uid, email: decoded.email }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 446, "column": 0}, "map": {"version":3,"sources":["file:///Users/santisanchez/Documents/GitHub/proyecto-gestor-uw/app/api/backoffice/centers/%5BcenterId%5D/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { adminDb } from \"@/lib/firebase/admin\"\nimport { requirePlatformAdmin } from \"@/lib/backoffice/server-auth\"\n\nexport async function GET(request: Request, { params }: { params: { centerId: string } | Promise<{ centerId: string }> }) {\n  try {\n    await requirePlatformAdmin(request)\n\n    const resolvedParams = await params\n    const centerId = resolvedParams?.centerId\n    if (!centerId) {\n      return NextResponse.json({ error: \"Missing centerId\" }, { status: 400 })\n    }\n\n    const centerRef = adminDb.collection(\"centers\").doc(centerId)\n    const snap = await centerRef.get()\n\n    const legacyRef = adminDb.collection(\"padel_centers\").doc(centerId)\n    const legacySnap = snap.exists ? null : await legacyRef.get()\n    if (!snap.exists && !legacySnap?.exists) {\n      return NextResponse.json({ error: \"Not found\" }, { status: 404 })\n    }\n\n    const source = snap.exists ? \"centers\" : \"padel_centers\"\n    const effectiveRef = snap.exists ? centerRef : legacyRef\n    const effectiveSnap = snap.exists ? snap : (legacySnap as any)\n\n    const courtsSnap = await effectiveRef.collection(\"courts\").get()\n\n    let bookingsCount = 0\n    try {\n      const bookingsSnap = await effectiveRef.collection(\"bookings\").limit(100).get()\n      bookingsCount = bookingsSnap.size\n    } catch {\n      // ignore\n    }\n\n    const data = effectiveSnap.data() as any\n\n    return NextResponse.json({\n      center: { centerId: effectiveSnap.id, source, ...(data || {}) },\n      courtsCount: courtsSnap.size,\n      bookingsCount,\n    })\n  } catch (e: any) {\n    if (e instanceof Response) return e\n    return NextResponse.json({ error: e?.message || \"Failed\" }, { status: 500 })\n  }\n}\n\nexport async function POST(request: Request, { params }: { params: { centerId: string } | Promise<{ centerId: string }> }) {\n  try {\n    await requirePlatformAdmin(request)\n\n    const resolvedParams = await params\n    const centerId = resolvedParams?.centerId\n    if (!centerId) {\n      return NextResponse.json({ error: \"Missing centerId\" }, { status: 400 })\n    }\n\n    const body = await request.json().catch(() => ({}))\n    const patch: Record<string, any> = {}\n\n    if (typeof body.published === \"boolean\") patch.published = body.published\n\n    if (typeof body.status === \"string\") {\n      if (![\"active\", \"suspended\"].includes(body.status)) {\n        return NextResponse.json({ error: \"Invalid status\" }, { status: 400 })\n      }\n      patch.status = body.status\n    }\n\n    if (body.featuredRank === null || typeof body.featuredRank === \"number\") {\n      patch.featuredRank = body.featuredRank\n    }\n\n    if (Object.keys(patch).length === 0) {\n      return NextResponse.json({ error: \"No changes\" }, { status: 400 })\n    }\n\n    patch.updatedAt = new Date()\n\n    const targetRef = adminDb.collection(\"centers\").doc(centerId)\n    const targetSnap = await targetRef.get()\n\n    // If this center only exists in legacy, seed a minimal /centers doc so it shows up everywhere.\n    if (!targetSnap.exists) {\n      const legacySnap = await adminDb.collection(\"padel_centers\").doc(centerId).get()\n      if (legacySnap.exists) {\n        const legacy = legacySnap.data() as any\n        await targetRef.set(\n          {\n            name: legacy?.name ?? \"\",\n            email: legacy?.email ?? \"\",\n            phone: legacy?.phone ?? \"\",\n            address: legacy?.address ?? \"\",\n            city: legacy?.city ?? \"\",\n            country: legacy?.country ?? \"\",\n            coverImageUrl: legacy?.imageUrl ?? null,\n            galleryImageUrls: legacy?.imageUrl ? [legacy.imageUrl] : [],\n            published: false,\n            featuredRank: null,\n            createdAt: legacy?.createdAt ?? new Date(),\n            updatedAt: new Date(),\n          },\n          { merge: true }\n        )\n      }\n    }\n\n    await targetRef.set(patch, { merge: true })\n    return NextResponse.json({ success: true })\n  } catch (e: any) {\n    if (e instanceof Response) return e\n    return NextResponse.json({ error: e?.message || \"Failed\" }, { status: 500 })\n  }\n}\n\nexport async function DELETE(request: Request, { params }: { params: { centerId: string } | Promise<{ centerId: string }> }) {\n  try {\n    await requirePlatformAdmin(request)\n\n    const resolvedParams = await params\n    const centerId = resolvedParams?.centerId\n    if (!centerId) {\n      return NextResponse.json({ error: \"Missing centerId\" }, { status: 400 })\n    }\n\n    // Delete from centers collection\n    const centerRef = adminDb.collection(\"centers\").doc(centerId)\n    const centerSnap = await centerRef.get()\n    \n    if (centerSnap.exists) {\n      // Delete subcollections first\n      const subcollections = [\"courts\", \"bookings\", \"settings\", \"classes\", \"availabilityRules\"]\n      for (const sub of subcollections) {\n        const subSnap = await centerRef.collection(sub).get()\n        const batch = adminDb.batch()\n        subSnap.docs.forEach((doc) => batch.delete(doc.ref))\n        if (subSnap.size > 0) await batch.commit()\n      }\n      await centerRef.delete()\n    }\n\n    // Delete from padel_centers (legacy) collection\n    const legacyRef = adminDb.collection(\"padel_centers\").doc(centerId)\n    const legacySnap = await legacyRef.get()\n    \n    if (legacySnap.exists) {\n      // Delete subcollections\n      const legacySubcollections = [\"courts\", \"bookings\", \"availability\"]\n      for (const sub of legacySubcollections) {\n        const subSnap = await legacyRef.collection(sub).get()\n        const batch = adminDb.batch()\n        subSnap.docs.forEach((doc) => batch.delete(doc.ref))\n        if (subSnap.size > 0) await batch.commit()\n      }\n      await legacyRef.delete()\n    }\n\n    // Delete user document\n    const userRef = adminDb.collection(\"users\").doc(centerId)\n    const userSnap = await userRef.get()\n    if (userSnap.exists) {\n      await userRef.delete()\n    }\n\n    return NextResponse.json({ success: true, message: \"Center deleted successfully\" })\n  } catch (e: any) {\n    if (e instanceof Response) return e\n    return NextResponse.json({ error: e?.message || \"Failed to delete center\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}